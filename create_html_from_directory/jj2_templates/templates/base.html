<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    {%block title%}
        <title>{{ path }}</title>
    {%endblock%}
    <style type="text/css">
        li {
            list-style-type: none;
            margin-bottom: 0.7rem;
        }
        
    </style>
    
</head>
<body>
<!-- Modal -->
<div class="modal fade " id="ModalPlayer" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="callout">
                                <h5 class="modal-title"></h5>
                                <div class="responsive-embed widescreen">

                                    <video controls class=" img-fluid" id="video-player" src = "">
                                        Your browser does not support the video element.
                                    </video>
                                </div>
                                <nav aria-label="Page navigation example">
                                    <ul class="pagination pagination-sm" id="pagination">
                                      <li class="page-item">
                                        <a class="page-link" href="#" target="_blank" aria-label="Previous" id="prev">Предыдущее видео</a>
                                      </li>
                                      
                                      <li class="page-item">
                                        <a class="page-link" href="#" target="_blank" aria-label="Next" id="next">Следующее видео</a>
                                      </li>
                                    </ul>
                                  </nav>
                                <!-- <a id="play_btn" class="button small" href="#" onclick = "togglePlay();">Play</a> -->
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>


        </div>
    </div>
</div>

<!-- Video playlist -->
    <div class="container">

        {%block content%}
         
        {%endblock%}
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>    


<!-- Open link in modal  -->


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>    


<!-- Open link in modal  -->


    <script>
        "use strict";
        
        const video = document.getElementById("video-player"),
            exampleModal = document.getElementById("ModalPlayer"),
            playlist = document.getElementById("playlist"),
            playListLinks = playlist.getElementsByTagName("a"),
            autoplayCheckbox = document.getElementById("checkAutoplay"),
            pagination = document.getElementById("pagination"),
            prevLink = document.getElementById("prev"),
            nextLink = document.getElementById("next");

           
        let fromStorageData, progressToStorage, progressFromStorage, currentFileIdx,
            modalTitle, button,
            videoAndCategoryName, link, elemProgressBar, autoplay,
            prevVideoLink, nextVideoLink,
            siblings;


        playlist.onload = fillProgressBar();
        playlist.onload = setAutoplayCheckbox();

        function initVideoPlayer(link){
            loadAndPlay(link);
            setPagination(link);

        };

        function playNextVideo(){
            initVideoPlayer(nextLink.href);
        };

        function paginationClicked(event){
            event.preventDefault();
            videoAndCategoryName = getCategoryName(event.originalTarget);
            modalTitle.textContent = videoAndCategoryName;
            initVideoPlayer(event.originalTarget.href);
            

            
        };

        // преобразует строку "true" в логическое true
        function boolFromString(string){
            if (string == "true"){
                return true;
            } else {
                return false;
            }
        };

        function getCategoryName(button){
            return button.getAttribute("data-bs-file")
        };

        // установка значения чекбокса из localStorage
        function setAutoplayCheckbox(){
            autoplay = boolFromString(window.localStorage.getItem("autoplayCheckbox"));
            autoplayCheckbox.checked = autoplay;
        };

        
        // заполняет прогрессбары по всему списку, из сохраненных значений прогресса
        function fillProgressBar(){
            let dataFromStorage;
            for (let a of Object.entries(playListLinks)){
                dataFromStorage = getStorageData(a[1].href);
                a[1].childNodes[3].childNodes[1].style.width = dataFromStorage.progress +"%";
            };
        };

        function getCurrentProgress(){
            return video.currentTime * 100 / video.duration;
        };

        function saveCurrentTime(){
            progressToStorage = getCurrentProgress();
            window.localStorage.setItem(video.src, Array(video.currentTime, progressToStorage));
        };

        function updateProgressBar(){
            elemProgressBar = playListLinks[currentFileIdx].childNodes[3].childNodes[1];
            elemProgressBar.style.width = getCurrentProgress()+"%"
        };


        function loadAndPlay(link){
            video.defaultPlaybackRate = 1.5;
            video.src = link;
            video.play();
            let dataFromStorage = getStorageData(link);
            video.currentTime = dataFromStorage.time;
        };

        function getStorageData(link){
            let time, progress;
            if (!!window.localStorage.getItem(link)){
                fromStorageData = window.localStorage.getItem(link).split(",")    
                    time = Number(fromStorageData[0]),
                    progress = Number(fromStorageData[1])
            } else { 
                time = 0;
                progress = 0;
            };
            return {
                    time: time,
                    progress: progress
                }
        };

        function getCurrentId(link){
            for (let a of Object.entries(playListLinks)){
                if (link == a[1].href) {
                    currentFileIdx = a[0];
                    };
            };
            return Number(currentFileIdx);
        };

        function getSiblings(currentFileIdx){
            let prev, next;
            if (Number(currentFileIdx) > 0){
                prev = Number(currentFileIdx) - 1;
            }else {
                prev = 0;
            };

            if (Number(currentFileIdx) < playListLinks.length - 1){
                next = Number(currentFileIdx) + 1;
            }else {
                next = playListLinks.length - 1;
            };
            return {
                prev: prev,
                next: next
            };
        };

        function setPagination(link){
            currentFileIdx = getCurrentId(link);
            siblings = getSiblings(currentFileIdx);
            if (siblings.prev == currentFileIdx){
                prevLink.style.display="none";
            }else{
                prevLink.style.display="";
            };
            if (siblings.next == currentFileIdx){
                nextLink.style.display="none";
            }else{
                nextLink.style.display="";
            };
            prevLink.href = playListLinks[siblings.prev].href;
            prevLink.setAttribute("data-bs-file", playListLinks[siblings.prev].getAttribute("data-bs-file"));
            nextLink.href = playListLinks[siblings.next].href;
            nextLink.setAttribute("data-bs-file", playListLinks[siblings.next].getAttribute("data-bs-file"));
        };
        

        // создание событий для различных элементов
        prevLink.addEventListener("click", paginationClicked);
        nextLink.addEventListener("click", paginationClicked);
        video.addEventListener("timeupdate", saveCurrentTime);
        video.addEventListener("timeupdate", updateProgressBar);
        video.addEventListener("pause", saveCurrentTime);
        video.addEventListener("ended", playNextVideo)
        window.addEventListener("unload", saveCurrentTime);
        autoplayCheckbox.addEventListener("change", function(event){
            window.localStorage.setItem("autoplayCheckbox", autoplayCheckbox.checked);
        });

       
        
        exampleModal.addEventListener("hide.bs.modal", function (event) {
            video.pause();
        });

        exampleModal.addEventListener("show.bs.modal", function (event) {
            button = event.relatedTarget;
            link = button.href;
            videoAndCategoryName = getCategoryName(button);
            modalTitle = exampleModal.querySelector(".modal-title");
            modalTitle.textContent = videoAndCategoryName;
            initVideoPlayer(link);


        });    

   
    </script> 


</body>
</html>